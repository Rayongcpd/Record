<!DOCTYPE html>
<html lang="th" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบทะเบียนคุมระเบียบข้อบังคับสหกรณ์</title>
    <meta name="description" content="ระบบบันทึกและติดตามระเบียบ/ข้อบังคับของสหกรณ์ กลุ่มจัดตั้งและส่งเสริมสหกรณ์">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Sarabun', sans-serif;
        }

        .gradient-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 50%, #3d7ab5 100%);
        }

        .card-shadow {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        /* Removed generic hover to allow specific status hovers */
        /* .table-row:hover {
            background-color: #f0f7ff;
        } */

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-complete {
            background: #d1fae5;
            color: #065f46;
        }

        .status-processing {
            background: #dbeafe;
            color: #1e40af;
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
        }

        .loading-overlay {
            background: rgba(255, 255, 255, 0.8);
        }

        /* Status Row Styles */
        .row-pending {
            background-color: #fffbeb;
            /* yellow-50 */
        }

        .row-pending:hover {
            background-color: #fef3c7;
            /* yellow-100 */
        }

        .row-processing {
            background-color: #eff6ff;
            /* blue-50 */
        }

        .row-processing:hover {
            background-color: #dbeafe;
            /* blue-100 */
        }

        .row-complete {
            background-color: #f0fdf4;
            /* green-50 */
        }

        .row-complete:hover {
            background-color: #dcfce7;
            /* green-100 */
        }
    </style>
</head>

<body class="h-full bg-gray-50">
    <div id="app" class="h-full w-full overflow-auto">
        <!-- Loading Overlay -->
        <div id="loading-overlay" class="fixed inset-0 z-[100] flex items-center justify-center loading-overlay hidden">
            <div class="text-center">
                <svg class="w-12 h-12 animate-spin text-blue-600 mx-auto" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <p class="mt-2 text-gray-600">กำลังโหลด...</p>
            </div>
        </div>

        <!-- Header -->
        <header class="gradient-header text-white py-6 px-4 shadow-lg">
            <div class="max-w-7xl mx-auto">
                <div class="flex items-center gap-3">
                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    <div>
                        <h1 class="text-2xl font-bold">ระบบทะเบียนคุมระเบียบข้อบังคับสหกรณ์</h1>
                        <p class="text-blue-100 text-sm">กลุ่มจัดตั้งและส่งเสริมสหกรณ์</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-30">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex space-x-8 overflow-x-auto">
                    <button onclick="switchView('dashboard')"
                        class="nav-item whitespace-nowrap border-b-2 border-blue-600 text-blue-600 py-4 px-1 text-sm font-medium transition-colors"
                        id="nav-dashboard">
                        <span class="flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                                </path>
                            </svg>
                            หน้าหลัก
                        </span>
                    </button>
                    <button onclick="switchView('daily-ops')"
                        class="nav-item whitespace-nowrap border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium transition-colors"
                        id="nav-daily-ops">
                        <span class="flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
                                </path>
                            </svg>
                            บันทึกปฏิบัติงาน
                        </span>
                    </button>
                    <button onclick="switchView('registry')"
                        class="nav-item whitespace-nowrap border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium transition-colors"
                        id="nav-registry">
                        <span class="flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                </path>
                            </svg>
                            ทะเบียนคุม
                        </span>
                    </button>
                    <button onclick="switchView('calendar')"
                        class="nav-item whitespace-nowrap border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium transition-colors"
                        id="nav-calendar">
                        <span class="flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                </path>
                            </svg>
                            ปฏิทิน
                        </span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-6">

            <!-- DASHBOARD VIEW -->
            <div id="view-dashboard" class="space-y-8 animate-fade-in">
                <!-- Welcome Section -->
                <div
                    class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-2xl p-8 text-white shadow-xl relative overflow-hidden">
                    <div
                        class="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full -mr-16 -mt-16 blur-2xl">
                    </div>
                    <div
                        class="absolute bottom-0 left-0 w-40 h-40 bg-white opacity-5 rounded-full -ml-10 -mb-10 blur-xl">
                    </div>

                    <div class="relative z-10">
                        <h2 class="text-3xl font-bold mb-2">ยินดีต้อนรับกลับ,</h2>
                        <p class="text-blue-100 text-lg mb-6">ระบบทะเบียนคุมระเบียบข้อบังคับสหกรณ์ พร้อมใช้งาน</p>

                        <div class="flex flex-wrap gap-4">
                            <button onclick="switchView('daily-ops'); openDailyOpModal()"
                                class="bg-white text-blue-600 px-6 py-2.5 rounded-lg font-semibold shadow-md hover:bg-blue-50 hover:shadow-lg transition-all flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4"></path>
                                </svg>
                                บันทึกงานใหม่
                            </button>
                            <button onclick="switchView('registry'); showModal()"
                                class="bg-indigo-500 bg-opacity-30 border border-white/30 text-white px-6 py-2.5 rounded-lg font-semibold hover:bg-opacity-40 transition-all flex items-center gap-2 backdrop-blur-sm">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                    </path>
                                </svg>
                                เพิ่มทะเบียนคุม
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <!-- Left: Recent Operations (Wider) -->
                    <div class="lg:col-span-7 space-y-4">
                        <div class="flex items-center justify-between">
                            <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <span class="bg-blue-100 p-2 rounded-lg text-blue-600">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </span>
                                การปฏิบัติงานล่าสุด
                            </h3>
                            <button onclick="switchView('daily-ops')"
                                class="text-sm text-blue-600 hover:text-blue-800 font-medium hover:underline">ดูทั้งหมด</button>
                        </div>

                        <div id="dashboard-daily-content"
                            class="bg-white rounded-2xl shadow-sm border border-gray-100 p-2 min-h-[300px]">
                            <p class="text-gray-400 text-center py-12 flex flex-col items-center">
                                <svg class="w-12 h-12 mb-3 opacity-20" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                กำลังโหลดข้อมูล...
                            </p>
                        </div>
                    </div>

                    <!-- Right: Registry Stats (Narrower) -->
                    <div class="lg:col-span-5 space-y-4">
                        <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <span class="bg-indigo-100 p-2 rounded-lg text-indigo-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                                    </path>
                                </svg>
                            </span>
                            สถานะทะเบียนคุม
                        </h3>

                        <div id="dashboard-registry-stats" class="grid grid-cols-2 gap-4">
                            <!-- Injected by JS -->
                        </div>

                        <!-- Quick Summary Chart Placeholder (Can be added later) -->
                        <div
                            class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl p-6 border border-gray-200 mt-4 text-center">
                            <p class="text-sm text-gray-500 mb-2">ความสำเร็จของงาน</p>
                            <div class="flex items-center justify-center gap-2">
                                <div class="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div id="progress-bar-success"
                                        class="h-full bg-green-500 w-0 transition-all duration-1000"></div>
                                </div>
                                <span id="progress-text-success" class="text-xs font-bold text-gray-700">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DAILY OPS VIEW -->
            <div id="view-daily-ops" class="hidden space-y-6 animate-fade-in">
                <!-- Header & Actions -->
                <div class="flex justify-between items-center bg-white p-4 rounded-xl card-shadow">
                    <h2 class="text-xl font-bold text-gray-800">บันทึกการปฏิบัติงานประจำวัน</h2>
                    <button onclick="openDailyOpModal()"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4">
                            </path>
                        </svg>
                        บันทึกงานใหม่
                    </button>
                </div>

                <!-- Daily Ops Content -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- List of Ops -->
                    <div class="lg:col-span-3">
                        <div class="bg-white rounded-xl card-shadow overflow-hidden">
                            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                                <h3 class="font-semibold text-gray-700">รายการปฏิบัติงานล่าสุด</h3>
                                <input type="date" id="daily-filter-date"
                                    class="border border-gray-300 rounded px-2 py-1 text-sm">
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm text-gray-600 font-medium">เวลา</th>
                                            <th class="px-4 py-3 text-left text-sm text-gray-600 font-medium">กิจกรรม
                                            </th>
                                            <th class="px-4 py-3 text-left text-sm text-gray-600 font-medium">สถานที่
                                            </th>
                                            <th class="px-4 py-3 text-left text-sm text-gray-600 font-medium">สถานะ</th>
                                            <th class="px-4 py-3 text-left text-sm text-gray-600 font-medium">จัดการ
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="daily-ops-table-body" class="divide-y divide-gray-100">
                                        <tr>
                                            <td colspan="5" class="p-4 text-center text-gray-500">
                                                เลือกวันที่เพื่อดูข้อมูล</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- REGISTRY VIEW (Existing Content Wrapped) -->
            <div id="view-registry" class="hidden">
                <!-- Stats Cards -->

                <!-- Stats Cards Removed as per user request -->


                <!-- Add New Button -->
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">ทะเบียนคุมระเบียบ/ข้อบังคับ</h2>
                    <button id="btn-add-new"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg font-medium flex items-center gap-2 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4">
                            </path>
                        </svg>
                        เพิ่มรายการใหม่
                    </button>
                </div>

                <!-- Filter -->
                <div class="bg-white rounded-xl p-4 card-shadow mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">ค้นหาสหกรณ์</label>
                            <input type="text" id="filter-search" placeholder="พิมพ์ชื่อสหกรณ์..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">ประเภทเอกสาร</label>
                            <select id="filter-type"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">ทั้งหมด</option>
                                <option value="ระเบียบ">ระเบียบ</option>
                                <option value="ข้อบังคับ">ข้อบังคับ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">สถานะ</label>
                            <select id="filter-status"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">ทั้งหมด</option>
                                <option value="รอดำเนินการ">รอดำเนินการ</option>
                                <option value="กำลังดำเนินการ">กำลังดำเนินการ</option>
                                <option value="ดำเนินการแล้ว">ดำเนินการแล้ว</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button id="btn-clear-filter"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">ล้างตัวกรอง</button>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ลำดับ</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ชื่อสหกรณ์</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ประเภท</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">หัวข้อ</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">รับจากสหกรณ์
                                    </th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ส่งกลับสหกรณ์
                                    </th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">
                                        วันทำการ<br>(สหกรณ์)
                                    </th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">รับจากฝ่ายบริหาร
                                    </th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">
                                        กลุ่มดำเนินการเสร็จ
                                    </th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">
                                        วันทำการ<br>(กลุ่ม)
                                    </th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">สถานะ</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ไฟล์แนบ</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="divide-y divide-gray-100">
                                <tr>
                                    <td colspan="12" class="px-4 py-12 text-center text-gray-500">
                                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                            </path>
                                        </svg>
                                        <p>กำลังโหลดข้อมูล...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                <div id="pagination-container"
                    class="mt-4 bg-white rounded-xl p-4 card-shadow flex flex-col sm:flex-row items-center justify-between gap-4 hidden">
                    <div class="flex items-center gap-2 text-sm text-gray-600">
                        <span>แสดง:</span>
                        <select id="page-size"
                            class="px-3 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span>รายการต่อหน้า</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="pagination-info" class="text-sm text-gray-600 mr-2">รายการ 1-10 จาก 100</span>
                        <button id="btn-first-page"
                            class="p-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                            title="หน้าแรก">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <button id="btn-prev-page"
                            class="p-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                            title="ก่อนหน้า">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7">
                                </path>
                            </svg>
                        </button>
                        <span class="px-3 py-1.5 bg-blue-50 text-blue-700 rounded-lg font-medium text-sm">
                            หน้า <span id="current-page">1</span> / <span id="total-pages">1</span>
                        </span>
                        <button id="btn-next-page"
                            class="p-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                            title="ถัดไป">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7">
                                </path>
                            </svg>
                        </button>
                        <button id="btn-last-page"
                            class="p-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                            title="หน้าสุดท้าย">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Summary Section -->
                <div id="summary-section" class="mt-6 bg-white rounded-xl p-6 card-shadow hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        สรุปทะเบียนคุม
                    </h3>
                    <div id="summary-content" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div> <!-- End view-registry -->

            <!-- CALENDAR VIEW -->
            <div id="view-calendar" class="hidden space-y-6 animate-fade-in">
                <div class="bg-white rounded-xl card-shadow p-6">
                    <!-- Calendar Header -->
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                            <span class="bg-indigo-100 p-2 rounded-lg text-indigo-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                    </path>
                                </svg>
                            </span>
                            <span id="calendar-month-year">...</span>
                        </h2>
                        <div class="flex items-center gap-2">
                            <button onclick="changeMonth(-1)"
                                class="p-2 hover:bg-gray-100 rounded-lg text-gray-600 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <button onclick="goToToday()"
                                class="px-3 py-1 text-sm bg-blue-50 text-blue-600 rounded-lg font-medium hover:bg-blue-100 transition-colors">
                                วันนี้
                            </button>
                            <button onclick="changeMonth(1)"
                                class="p-2 hover:bg-gray-100 rounded-lg text-gray-600 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="grid grid-cols-7 gap-px bg-gray-200 rounded-lg overflow-hidden border border-gray-200">
                        <!-- Days Header -->
                        <div class="bg-gray-50 p-2 text-center text-sm font-semibold text-gray-700">อา.</div>
                        <div class="bg-gray-50 p-2 text-center text-sm font-semibold text-gray-700">จ.</div>
                        <div class="bg-gray-50 p-2 text-center text-sm font-semibold text-gray-700">อ.</div>
                        <div class="bg-gray-50 p-2 text-center text-sm font-semibold text-gray-700">พ.</div>
                        <div class="bg-gray-50 p-2 text-center text-sm font-semibold text-gray-700">พฤ.</div>
                        <div class="bg-gray-50 p-2 text-center text-sm font-semibold text-gray-700">ศ.</div>
                        <div class="bg-gray-50 p-2 text-center text-sm font-semibold text-gray-700">ส.</div>

                        <!-- Calendar Days will be injected here -->
                        <div id="calendar-grid" class="col-span-7 grid grid-cols-7 gap-px bg-gray-200">
                            <!-- JS will populate this -->
                        </div>
                    </div>
                </div>

                <!-- Legend -->
                <div class="flex flex-wrap gap-4 text-sm text-gray-600 px-2 justify-center">
                    <div class="flex items-center gap-1.5">
                        <span class="w-3 h-3 rounded-full bg-blue-500"></span> รับจากสหกรณ์
                    </div>
                    <div class="flex items-center gap-1.5">
                        <span class="w-3 h-3 rounded-full bg-green-500"></span> ส่งกลับสหกรณ์
                    </div>
                    <div class="flex items-center gap-1.5">
                        <span class="w-3 h-3 rounded-full bg-orange-500"></span> รับจากฝ่ายบริหาร
                    </div>
                    <div class="flex items-center gap-1.5">
                        <span class="w-3 h-3 rounded-full bg-purple-500"></span> กลุ่มเสร็จ
                    </div>
                    <div class="flex items-center gap-1.5">
                        <span class="w-3 h-3 rounded-full bg-gray-500"></span> ปฏิบัติงาน
                    </div>
                </div>
            </div>

            <!-- Calendar Event Modal -->
            <div id="calendar-modal" class="fixed inset-0 z-50 hidden">
                <div class="modal-backdrop absolute inset-0" onclick="closeCalendarModal()"></div>
                <div class="relative flex items-center justify-center min-h-full p-4">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md relative max-h-[80vh] overflow-y-auto">
                        <div
                            class="sticky top-0 bg-white border-b border-gray-100 px-6 py-4 rounded-t-xl flex justify-between items-center">
                            <h3 id="calendar-modal-date" class="font-bold text-gray-800 text-lg">รายละเอียด</h3>
                            <button onclick="closeCalendarModal()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="calendar-modal-content" class="p-6 space-y-3">
                            <!-- Events injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Daily Ops Modal -->
        <div id="daily-ops-modal" class="fixed inset-0 z-50 hidden">
            <div class="modal-backdrop absolute inset-0"></div>
            <div class="relative flex items-center justify-center min-h-full p-4">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg relative max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 rounded-t-2xl">
                        <h2 id="daily-modal-title" class="text-xl font-semibold text-gray-800">บันทึกงานใหม่</h2>
                        <button onclick="closeDailyOpModal()"
                            class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <form id="form-daily-op" class="p-6 space-y-4">
                        <input type="hidden" id="daily-id">

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">วันที่ <span
                                    class="text-red-500">*</span></label>
                            <input type="date" id="daily-date" required
                                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">เวลา <span
                                    class="text-red-500">*</span></label>
                            <input type="time" id="daily-time" required
                                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">กิจกรรม <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="daily-activity" required placeholder="เช่น ตรวจสอบระเบียบ..."
                                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">รายละเอียด</label>
                            <textarea id="daily-details" rows="2" placeholder="ระบุรายละเอียดเพิ่มเติม..."
                                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">สถานที่ <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="daily-location" required placeholder="เช่น สหกรณ์..."
                                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">สถานะ</label>
                            <select id="daily-status"
                                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="รอดำเนินการ">รอดำเนินการ</option>
                                <option value="กำลังดำเนินการ">กำลังดำเนินการ</option>
                                <option value="ดำเนินการแล้ว">ดำเนินการแล้ว</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label>
                            <textarea id="daily-notes" rows="2"
                                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>

                        <div class="flex gap-3 pt-4 border-t border-gray-200">
                            <button type="button" onclick="closeDailyOpModal()"
                                class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium">ยกเลิก</button>
                            <button type="submit" id="btn-save-daily"
                                class="flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium flex items-center justify-center gap-2">
                                <span>บันทึก</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Add/Edit Modal -->
        <div id="modal" class="fixed inset-0 z-50 hidden">
            <div class="modal-backdrop absolute inset-0" id="modal-backdrop"></div>
            <div class="relative flex items-center justify-center min-h-full p-4">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto relative">
                    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 rounded-t-2xl">
                        <h2 id="modal-title" class="text-xl font-semibold text-gray-800">เพิ่มรายการใหม่</h2>
                        <button id="btn-close-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <form id="form-record" class="p-6 space-y-4">
                        <input type="hidden" id="record-id">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">ชื่อสหกรณ์ <span
                                        class="text-red-500">*</span></label>
                                <input type="text" id="input-coop-name" list="coop-names-list" required
                                    class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="พิมพ์เพื่อค้นหาชื่อสหกรณ์..." autocomplete="off">
                                <datalist id="coop-names-list"></datalist>
                            </div>
                            <div class="md:col-span-2">
                                <div class="flex items-center justify-between mb-2">
                                    <label class="block text-sm font-medium text-gray-700">รายการเอกสาร <span
                                            class="text-red-500">*</span></label>
                                    <button type="button" id="btn-add-doc-item"
                                        class="text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 4v16m8-8H4"></path>
                                        </svg>
                                        เพิ่มรายการ
                                    </button>
                                </div>
                                <div id="doc-items-container" class="space-y-3">
                                    <!-- Dynamic rows will be here -->
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-gray-200 pt-4">
                            <h4 class="font-medium text-gray-800 mb-3 flex items-center gap-2">
                                <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-sm">1</span>
                                การรับ-ส่งหนังสือสหกรณ์
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label
                                        class="block text-sm font-medium text-gray-700 mb-1">วันที่รับหนังสือจากสหกรณ์</label>
                                    <input type="date" id="input-receive-coop"
                                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-medium text-gray-700 mb-1">วันที่ส่งหนังสือกลับสหกรณ์</label>
                                    <input type="date" id="input-send-coop"
                                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <div id="coop-days-info" class="mt-2 text-sm text-blue-600 hidden"></div>
                        </div>

                        <div class="border-t border-gray-200 pt-4">
                            <h4 class="font-medium text-gray-800 mb-3 flex items-center gap-2">
                                <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-sm">2</span>
                                การดำเนินการของกลุ่มจัดตั้งฯ
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label
                                        class="block text-sm font-medium text-gray-700 mb-1">วันที่รับจากฝ่ายบริหารฯ</label>
                                    <input type="date" id="input-receive-admin"
                                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-medium text-gray-700 mb-1">วันที่กลุ่มดำเนินการเสร็จ</label>
                                    <input type="date" id="input-group-complete"
                                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <div id="group-days-info" class="mt-2 text-sm text-green-600 hidden"></div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">สถานะ</label>
                            <select id="input-status"
                                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="รอดำเนินการ">รอดำเนินการ</option>
                                <option value="กำลังดำเนินการ">กำลังดำเนินการ</option>
                                <option value="ดำเนินการแล้ว">ดำเนินการแล้ว</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label>
                            <textarea id="input-notes" rows="2"
                                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="รายละเอียดเพิ่มเติม..."></textarea>
                        </div>

                        <!-- File Attachment Section -->
                        <div class="border-t border-gray-200 pt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                📎 ไฟล์แนบ
                            </label>
                            <div id="attachment-container">
                                <!-- Existing Attachment -->
                                <div id="current-attachment"
                                    class="hidden mb-3 p-3 bg-gray-50 rounded-lg flex items-center justify-between border border-gray-200">
                                    <div class="flex items-center gap-2 overflow-hidden">
                                        <svg class="w-5 h-5 text-blue-600 flex-shrink-0" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13">
                                            </path>
                                        </svg>
                                        <a id="attachment-link" href="#" target="_blank"
                                            class="text-blue-600 hover:underline truncate"></a>
                                    </div>
                                    <button type="button" id="btn-remove-attachment"
                                        class="text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-50 transition-colors"
                                        title="ลบไฟล์">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                            </path>
                                        </svg>
                                    </button>
                                </div>

                                <!-- Drop zone -->
                                <div id="file-drop-zone"
                                    class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 hover:bg-blue-50 transition-all cursor-pointer">
                                    <div id="drop-zone-content">
                                        <svg class="w-10 h-10 mx-auto text-gray-400 mb-2" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                                            </path>
                                        </svg>
                                        <p class="text-sm text-gray-600">ลากไฟล์มาวางที่นี่ หรือ <span
                                                class="text-blue-600 font-medium">คลิกเพื่อเลือกไฟล์</span></p>
                                        <p class="text-xs text-gray-400 mt-1">รองรับ: PDF, JPG, PNG, DOC, DOCX
                                            (ขนาดไม่เกิน 10MB)</p>
                                    </div>
                                    <div id="selected-file-display" class="hidden">
                                        <p class="text-sm font-medium text-gray-800 break-all" id="selected-file-name">
                                        </p>
                                        <p class="text-xs text-gray-500 mt-1" id="selected-file-size"></p>
                                        <button type="button" id="btn-cancel-upload"
                                            class="mt-2 text-xs text-red-600 hover:text-red-800 underline">ยกเลิก</button>
                                    </div>
                                    <input type="file" id="file-input" class="hidden"
                                        accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                                </div>

                                <!-- Progress bar -->
                                <div id="upload-progress" class="hidden mt-3">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-xs font-medium text-blue-700">กำลังอัพโหลด...</span>
                                        <span id="progress-text" class="text-xs font-medium text-blue-700">0%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                                        <div id="progress-bar"
                                            class="bg-blue-600 h-2.5 rounded-full transition-all duration-300"
                                            style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-3 pt-4 border-t border-gray-200">
                            <button type="button" id="btn-cancel"
                                class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors font-medium">ยกเลิก</button>
                            <button type="submit" id="btn-save"
                                class="flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium flex items-center justify-center gap-2">
                                <span>บันทึก</span>
                                <svg id="save-spinner" class="w-5 h-5 animate-spin hidden" fill="none"
                                    viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation -->
        <div id="delete-modal" class="fixed inset-0 z-50 hidden">
            <div class="modal-backdrop absolute inset-0"></div>
            <div class="relative flex items-center justify-center min-h-full p-4">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 relative">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                </path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">ยืนยันการลบ</h3>
                        <p class="text-gray-600 mb-6">คุณต้องการลบรายการนี้หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้</p>
                        <div class="flex gap-3">
                            <button id="btn-cancel-delete"
                                class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors font-medium">ยกเลิก</button>
                            <button id="btn-confirm-delete"
                                class="flex-1 px-4 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors font-medium flex items-center justify-center gap-2">
                                <span>ลบ</span>
                                <svg id="delete-spinner" class="w-5 h-5 animate-spin hidden" fill="none"
                                    viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- View Details Modal -->
        <div id="view-details-modal" class="fixed inset-0 z-50 hidden">
            <div class="modal-backdrop absolute inset-0 bg-gray-900 bg-opacity-50 transition-opacity"
                onclick="closeViewDetailsModal()"></div>
            <div class="relative flex items-center justify-center min-h-full p-4 pointer-events-none">
                <div
                    class="bg-white rounded-2xl shadow-2xl w-full max-w-md relative overflow-hidden pointer-events-auto transform transition-all scale-100">
                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-white">รายละเอียดกิจกรรม</h3>
                        <button onclick="closeViewDetailsModal()"
                            class="text-blue-100 hover:text-white transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <p class="text-xs text-gray-500 mb-1">กิจกรรม</p>
                            <p id="view-activity" class="text-lg font-semibold text-gray-800"></p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">รายละเอียดเพิ่มเติม</p>
                            <div id="view-details"
                                class="bg-gray-50 rounded-lg p-3 text-sm text-gray-700 min-h-[60px] whitespace-pre-wrap">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-gray-500 mb-1">วันที่-เวลา</p>
                                <p id="view-datetime" class="text-sm font-medium text-gray-800"></p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 mb-1">สถานที่</p>
                                <p id="view-location" class="text-sm font-medium text-gray-800"></p>
                            </div>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">สถานะ</p>
                            <span id="view-status" class="inline-block px-2 py-1 rounded text-xs font-medium"></span>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-6 py-3 flex justify-end">
                        <button onclick="closeViewDetailsModal()"
                            class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg text-sm font-medium transition-colors">ปิด</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div id="toast"
            class="fixed bottom-4 right-4 transform translate-y-20 opacity-0 transition-all duration-300 z-50">
            <div class="bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3">
                <svg id="toast-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span id="toast-message">บันทึกสำเร็จ</span>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIG ====================
        // 🔴 สำคัญ: เปลี่ยน URL นี้เป็น Web App URL ของคุณหลังจาก Deploy
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbygBTVqnvvc7cTwf8YIQCQpJ5xLKU7Z4TEuycKCcQP4UPfo6uXeONMUBwMxRRhD7C6xtQ/exec';

        // Thai Public Holidays 2024-2026 (สำหรับคำนวณวันทำการใน Frontend)
        const PUBLIC_HOLIDAYS = [
            // 2024
            '2024-01-01', '2024-01-02', '2024-02-26', '2024-04-06', '2024-04-08',
            '2024-04-13', '2024-04-14', '2024-04-15', '2024-04-16', '2024-05-01',
            '2024-05-04', '2024-05-06', '2024-05-22', '2024-06-03', '2024-07-20',
            '2024-07-21', '2024-07-22', '2024-07-28', '2024-07-29', '2024-08-12',
            '2024-10-13', '2024-10-14', '2024-10-23', '2024-12-05', '2024-12-10',
            '2024-12-31',
            // 2025
            '2025-01-01', '2025-02-14', '2025-04-06', '2025-04-07', '2025-04-13',
            '2025-04-14', '2025-04-15', '2025-05-01', '2025-05-04', '2025-05-11',
            '2025-05-12', '2025-06-03', '2025-07-10', '2025-07-28', '2025-08-12',
            '2025-10-13', '2025-10-23', '2025-12-05', '2025-12-10', '2025-12-31',
            // 2026
            '2026-01-01', '2026-01-02', '2026-03-03', '2026-04-06', '2026-04-13',
            '2026-04-14', '2026-04-15', '2026-05-04', '2026-05-13', '2026-05-31',
            '2026-06-01', '2026-06-03', '2026-07-28', '2026-07-29', '2026-07-30',
            '2026-08-12', '2026-10-13', '2026-10-23', '2026-12-05', '2026-12-07',
            '2026-12-10', '2026-12-31'
        ];

        // ==================== STATE ====================
        let allRecords = [];
        let allDailyOps = []; // New state for Daily Operations
        let filteredRecords = [];
        let recordToDelete = null;
        let isEditing = false;
        let isDailyEditing = false; // New state for Daily Edit
        let selectedFile = null;
        let currentAttachment = null;
        let currentView = 'dashboard';

        // Pagination state
        let currentPage = 1;
        let pageSize = 10;

        // ==================== NAVIGATION & VIEW LOGIC ====================

        function switchView(viewName) {
            // Hide all views
            ['dashboard', 'daily-ops', 'registry', 'calendar'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
                document.getElementById(`nav-${v}`).classList.replace('text-blue-600', 'text-gray-500');
                document.getElementById(`nav-${v}`).classList.replace('border-blue-600', 'border-transparent');
            });

            // Show selected view
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            const navBtn = document.getElementById(`nav-${viewName}`);
            navBtn.classList.replace('text-gray-500', 'text-blue-600');
            navBtn.classList.replace('border-transparent', 'border-blue-600');

            currentView = viewName;

            // Load data if needed
            if (viewName === 'dashboard') {
                renderDashboard();
            } else if (viewName === 'daily-ops' && allDailyOps.length === 0) {
                fetchDailyOps();
            } else if (viewName === 'registry' && allRecords.length === 0) {
                fetchAllRecords();
            } else if (viewName === 'calendar') {
                // Ensure both data sources are loaded for calendar
                Promise.all([
                    allRecords.length === 0 ? fetchAllRecords(false) : Promise.resolve(),
                    allDailyOps.length === 0 ? fetchDailyOps(false) : Promise.resolve()
                ]).then(() => {
                    renderCalendar();
                });
            }
        }

        // ==================== CALENDAR LOGIC ====================
        let currentCalendarDate = new Date();

        function renderCalendar() {
            const date = currentCalendarDate;
            const year = date.getFullYear();
            const month = date.getMonth();

            // Update Header
            const thaiMonths = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            document.getElementById('calendar-month-year').textContent = `${thaiMonths[month]} ${year + 543}`;

            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            // Days from previous month to fill start
            const startingDay = firstDay.getDay(); // 0 = Sunday
            const prevMonthLastDay = new Date(year, month, 0).getDate();

            // Previous month days
            for (let i = startingDay - 1; i >= 0; i--) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'bg-white min-h-[100px] p-2 text-gray-400 text-sm opacity-50';
                dayDiv.textContent = prevMonthLastDay - i;
                grid.appendChild(dayDiv);
            }

            // Current month days
            const events = mapDataToEvents(year, month);

            for (let i = 1; i <= lastDay.getDate(); i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const dayEvents = events[dateStr] || [];
                const isToday = isDateToday(dateStr);
                const isHoliday = PUBLIC_HOLIDAYS.includes(dateStr);

                const dayDiv = document.createElement('div');

                // Styling: Highlighting holidays
                let borderClass = 'border-transparent';
                if (isToday) borderClass = 'border-blue-500';
                else if (isHoliday) borderClass = 'border-red-200 bg-red-50/30';

                dayDiv.className = `bg-white min-h-[100px] p-2 hover:bg-gray-50 transition-colors cursor-pointer border-t-2 ${borderClass}`;
                dayDiv.onclick = () => openCalendarModal(dateStr, dayEvents);

                // Date Number Style
                let dateNumberClass = 'text-gray-700';
                if (isToday) dateNumberClass = 'text-blue-600 bg-blue-100 rounded-full w-6 h-6 flex items-center justify-center';
                else if (isHoliday) dateNumberClass = 'text-red-600 font-bold';

                let html = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-bold text-sm ${dateNumberClass}">
                            ${i} 
                            ${isHoliday && !isToday ? '<span class="text-[10px] font-normal ml-1 bg-red-100 text-red-600 px-1 rounded">วันหยุด</span>' : ''}
                        </span>
                        ${dayEvents.length > 0 ? `<span class="text-xs text-gray-400 font-medium">${dayEvents.length} รายการ</span>` : ''}
                    </div>
                    <div class="space-y-1">
                `;

                // Show max 3 events preview
                dayEvents.slice(0, 3).forEach(event => {
                    html += `
                        <div class="text-[10px] truncate px-1.5 py-0.5 rounded ${event.bgColor} ${event.textColor}">
                            ${event.title}
                        </div>
                    `;
                });

                if (dayEvents.length > 3) {
                    html += `<div class="text-[10px] text-gray-500 pl-1">+ อีก ${dayEvents.length - 3} รายการ</div>`;
                }

                html += `</div>`;
                dayDiv.innerHTML = html;
                grid.appendChild(dayDiv);
            }

            // Next month days to fill grid (assuming 6 rows max = 42 cells)
            const totalCells = startingDay + lastDay.getDate();
            const remainingCells = 42 - totalCells;

            for (let i = 1; i <= remainingCells; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'bg-white min-h-[100px] p-2 text-gray-400 text-sm opacity-50';
                dayDiv.textContent = i;
                grid.appendChild(dayDiv);
            }
        }

        function mapDataToEvents(year, month) {
            const events = {};

            // 1. Map Registry Data
            allRecords.forEach(record => {
                // Receive from Coop (Blue)
                if (record.receive_from_coop_date) addEvent(events, record.receive_from_coop_date, `รับ: ${record.cooperative_name}`, 'bg-blue-100', 'text-blue-700', record);
                // Send back to Coop (Green)
                if (record.send_back_to_coop_date) addEvent(events, record.send_back_to_coop_date, `ส่ง: ${record.cooperative_name}`, 'bg-green-100', 'text-green-700', record);
                // Receive from Admin (Orange)
                if (record.receive_from_admin_date) addEvent(events, record.receive_from_admin_date, `บริหาร: ${record.cooperative_name}`, 'bg-orange-100', 'text-orange-700', record);
                // Group Complete (Purple)
                if (record.group_complete_date) addEvent(events, record.group_complete_date, `เสร็จ: ${record.cooperative_name}`, 'bg-purple-100', 'text-purple-700', record);
            });

            // 2. Map Daily Ops Data
            allDailyOps.forEach(op => {
                if (op.date) {
                    addEvent(events, op.date, `งาน: ${op.activity}`, 'bg-gray-100', 'text-gray-700', op, true);
                }
            });

            return events;
        }

        function addEvent(eventsMap, dateStr, title, bgColor, textColor, data, isDailyOp = false) {
            // Ensure dateStr is valid YYYY-MM-DD
            if (!dateStr || typeof dateStr !== 'string') return;
            const cleanDate = dateStr.split('T')[0];

            if (!eventsMap[cleanDate]) {
                eventsMap[cleanDate] = [];
            }
            eventsMap[cleanDate].push({
                title,
                bgColor,
                textColor,
                data,
                isDailyOp
            });
        }

        function isDateToday(dateStr) {
            const today = new Date().toISOString().split('T')[0];
            return dateStr === today;
        }

        function changeMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }

        function goToToday() {
            currentCalendarDate = new Date();
            renderCalendar();
        }

        function openCalendarModal(dateStr, events) {
            if (!events || events.length === 0) return;

            const date = new Date(dateStr);
            const thaiDate = date.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' });
            document.getElementById('calendar-modal-date').textContent = thaiDate;

            const content = document.getElementById('calendar-modal-content');
            content.innerHTML = events.map(event => `
                <div class="p-3 rounded-lg border border-gray-100 hover:shadow-sm transition-shadow ${event.bgColor.replace('100', '50')}">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="w-2 h-2 rounded-full ${event.bgColor.replace('bg-', 'bg-').replace('100', '500')}"></span>
                        <h4 class="font-bold text-gray-800 text-sm">${event.title}</h4>
                    </div>
                    ${event.isDailyOp ?
                    `<p class="text-xs text-gray-600 ml-4">${event.data.time ? formatTime(event.data.time) + ' น. ' : ''}${event.data.location || ''}</p>
                         ${event.data.activity_details ? `<p class="text-xs text-gray-500 ml-4 mt-1 line-clamp-2">${event.data.activity_details}</p>` : ''}`
                    :
                    `<p class="text-xs text-gray-600 ml-4">${event.data.document_type || ''} - ${event.data.document_topic || ''}</p>
                         <p class="text-xs text-gray-500 ml-4">สถานะ: ${event.data.status}</p>`
                }
                </div>
            `).join('');

            document.getElementById('calendar-modal').classList.remove('hidden');
        }

        function closeCalendarModal() {
            document.getElementById('calendar-modal').classList.add('hidden');
        }

        // ==================== DAILY OPS LOGIC ====================

        async function fetchDailyOps() {
            try {
                showLoading(true);
                const response = await fetch(`${SCRIPT_URL}?action=getDailyOps`, { redirect: 'follow' });
                const result = await response.json();

                if (result.success) {
                    allDailyOps = result.data;
                    renderDailyOpsTable();
                    renderDashboard(); // Refresh dashboard if data changed
                } else {
                    showToast('โหลดข้อมูลงานประจำวันไม่สำเร็จ', 'error');
                }
            } catch (error) {
                console.error('Error fetching daily ops:', error);
                showToast('ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์', 'error');
            } finally {
                showLoading(false);
            }
        }

        function renderDailyOpsTable() {
            const tbody = document.getElementById('daily-ops-table-body');
            const filterDate = document.getElementById('daily-filter-date').value;

            let displayData = allDailyOps;
            if (filterDate) {
                displayData = allDailyOps.filter(op => op.date === filterDate);
            }

            // Sort by Date DESC, Time DESC
            displayData.sort((a, b) => {
                if (a.date !== b.date) return new Date(b.date) - new Date(a.date);
                return b.time.localeCompare(a.time);
            });

            if (displayData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">ไม่พบข้อมูล</td></tr>`;
                return;
            }

            tbody.innerHTML = displayData.map(op => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-800">
                        <div class="font-medium">${formatDate(op.date)}</div>
                        <div class="text-xs text-gray-500">${formatTime(op.time)}</div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-800">${op.activity}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${op.location}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 rounded text-xs font-medium ${getStatusColor(op.status)}">
                            ${op.status}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <button onclick='viewDailyOpDetails(${JSON.stringify(op).replace(/'/g, "&#39;")})' class="text-gray-500 hover:text-blue-600 hover:underline mr-2" title="ดูรายละเอียด">
                            <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        </button>
                        <button onclick='editDailyOp(${JSON.stringify(op).replace(/'/g, "&#39;")})' class="text-blue-600 hover:underline mr-2">แก้ไข</button>
                        <button onclick="deleteDailyOp('${op.id}')" class="text-red-600 hover:underline">ลบ</button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusColor(status) {
            switch (status) {
                case 'ดำเนินการแล้ว': return 'bg-green-100 text-green-700';
                case 'กำลังดำเนินการ': return 'bg-blue-100 text-blue-700';
                default: return 'bg-yellow-100 text-yellow-700';
            }
        }

        function openDailyOpModal() {
            isDailyEditing = false;
            document.getElementById('daily-modal-title').textContent = 'บันทึกงานใหม่';
            document.getElementById('form-daily-op').reset();
            document.getElementById('daily-id').value = '';

            // Set default date/time
            const now = new Date();
            document.getElementById('daily-date').value = now.toISOString().split('T')[0];

            // Format HH:mm
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('daily-time').value = `${hours}:${minutes}`;
            document.getElementById('daily-details').value = '';

            document.getElementById('daily-ops-modal').classList.remove('hidden');
        }

        function closeDailyOpModal() {
            document.getElementById('daily-ops-modal').classList.add('hidden');
        }

        function viewDailyOpDetails(op) {
            document.getElementById('view-activity').textContent = op.activity || '-';
            document.getElementById('view-details').textContent = op.activity_details || '-';
            document.getElementById('view-datetime').textContent = `${formatDate(op.date)} เวลา ${formatTime(op.time)} น.`;
            document.getElementById('view-location').textContent = op.location || '-';

            const statusSpan = document.getElementById('view-status');
            statusSpan.className = `inline-block px-2 py-1 rounded text-xs font-medium ${getStatusColor(op.status)}`;
            statusSpan.textContent = op.status;

            document.getElementById('view-details-modal').classList.remove('hidden');
        }

        function closeViewDetailsModal() {
            document.getElementById('view-details-modal').classList.add('hidden');
        }

        function editDailyOp(op) {
            isDailyEditing = true;
            document.getElementById('daily-modal-title').textContent = 'แก้ไขงาน';
            document.getElementById('daily-id').value = op.id;
            document.getElementById('daily-date').value = op.date;
            document.getElementById('daily-time').value = op.time;
            document.getElementById('daily-activity').value = op.activity;
            document.getElementById('daily-details').value = op.activity_details || '';
            document.getElementById('daily-location').value = op.location;
            document.getElementById('daily-status').value = op.status;
            document.getElementById('daily-notes').value = op.notes || '';
            document.getElementById('daily-ops-modal').classList.remove('hidden');
        }

        async function handleDailyOpSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-save-daily');
            btn.disabled = true;
            btn.textContent = 'กำลงบันทึก...';

            const record = {
                id: document.getElementById('daily-id').value,
                date: document.getElementById('daily-date').value,
                time: document.getElementById('daily-time').value,
                activity: document.getElementById('daily-activity').value,
                activity_details: document.getElementById('daily-details').value,
                location: document.getElementById('daily-location').value,
                status: document.getElementById('daily-status').value,
                notes: document.getElementById('daily-notes').value
            };

            const action = isDailyEditing ? 'updateDailyOp' : 'createDailyOp';

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    body: JSON.stringify({ action, record })
                });
                const result = await response.json();

                if (result.success) {
                    showToast('บันทึกสำเร็จ');
                    closeDailyOpModal();
                    fetchDailyOps();
                } else {
                    showToast('บันทึกไม่สำเร็จ: ' + result.error, 'error');
                }
            } catch (error) {
                console.error(error);
                showToast('เกิดข้อผิดพลาด', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'บันทึก';
            }
        }

        async function deleteDailyOp(id) {
            if (!confirm('ยืนยันการลบข้อมูล?')) return;

            try {
                showLoading(true);
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    body: JSON.stringify({ action: 'deleteDailyOp', id })
                });
                const result = await response.json();
                if (result.success) {
                    showToast('ลบข้อมูลสำเร็จ');
                    fetchDailyOps();
                } else {
                    showToast('ลบไม่สำเร็จ: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('เกิดข้อผิดพลาด', 'error');
            } finally {
                showLoading(false);
            }
        }

        function formatTime(timeStr) {
            if (!timeStr) return '-';
            // Check if it's an ISO string (contains T)
            if (typeof timeStr === 'string' && timeStr.includes('T')) {
                try {
                    const date = new Date(timeStr);
                    return date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false });
                } catch (e) {
                    return timeStr.substring(0, 5);
                }
            }
            // Fallback for simple time strings "HH:mm"
            return String(timeStr).substring(0, 5);
        }

        // ==================== DASHBOARD LOGIC ====================

        function renderDashboard() {
            // Recent Ops (Top 5)
            // Sort by Date DESC, Time DESC
            const sortedOps = [...allDailyOps].sort((a, b) => {
                if (a.date !== b.date) return new Date(b.date) - new Date(a.date);
                return b.time.localeCompare(a.time);
            }).slice(0, 5); // Take top 5

            const dailyContainer = document.getElementById('dashboard-daily-content');
            if (sortedOps.length === 0) {
                dailyContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-gray-300">
                        <svg class="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        <p class="text-lg font-medium">ยังไม่มีรายการปฏิบัติงาน</p>
                        <p class="text-sm">เริ่มบันทึกงานโดยกดปุ่ม "บันทึกงานใหม่"</p>
                    </div>
                `;
            } else {
                dailyContainer.innerHTML = `
                    <div class="space-y-3">
                        ${sortedOps.map(op => `
                            <div class="group flex items-start gap-4 p-4 bg-gray-50 hover:bg-white rounded-xl border border-gray-100 hover:shadow-md transition-all duration-200 cursor-pointer" onclick='viewDailyOpDetails(${JSON.stringify(op).replace(/'/g, "&#39;")})'>
                                <div class="flex flex-col items-center min-w-[60px]">
                                    <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">${formatDate(op.date).split('/')[1] || '-'}</div>
                                    <div class="text-xl font-bold text-gray-800">${formatDateShort(op.date).day}</div>
                                </div>
                                <div class="w-px h-10 bg-gray-200 self-center"></div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-start">
                                        <h4 class="font-bold text-gray-800 truncate pr-2">${op.activity}</h4>
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs font-medium px-2 py-0.5 rounded-full whitespace-nowrap ${getStatusColor(op.status)}">${op.status}</span>
                                            <button class="text-gray-400 hover:text-blue-600 transition-colors" title="ดูรายละเอียด">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3 mt-1 text-sm text-gray-500">
                                        <div class="flex items-center gap-1">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            ${formatTime(op.time)} น.
                                        </div>
                                        <div class="flex items-center gap-1 truncate">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                            ${op.location}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Registry Stats
            const total = allRecords.length;
            const pending = allRecords.filter(r => r.status === 'รอดำเนินการ').length;
            const process = allRecords.filter(r => r.status === 'กำลังดำเนินการ').length;
            const done = allRecords.filter(r => r.status === 'ดำเนินการแล้ว').length;

            // Calculate success percentage
            const successPercent = total > 0 ? Math.round((done / total) * 100) : 0;
            const progressBar = document.getElementById('progress-bar-success');
            const progressText = document.getElementById('progress-text-success');
            if (progressBar) progressBar.style.width = `${successPercent}%`;
            if (progressText) progressText.innerText = `${successPercent}%`;

            document.getElementById('dashboard-registry-stats').innerHTML = `
                <div class="col-span-2 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-5 text-white shadow-lg shadow-blue-200 relative overflow-hidden group">
                    <div class="absolute right-0 top-0 w-24 h-24 bg-white opacity-10 rounded-full -mr-6 -mt-6 group-hover:scale-110 transition-transform duration-500"></div>
                    <div class="relative z-10">
                        <div class="text-blue-100 text-sm font-medium mb-1">ทะเบียนทั้งหมด</div>
                        <div class="text-4xl font-bold tracking-tight">${total}</div>
                        <div class="mt-2 text-xs text-blue-100 opacity-80">รายการ</div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                    <div class="w-8 h-8 rounded-lg bg-yellow-100 text-yellow-600 flex items-center justify-center mb-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <div class="text-2xl font-bold text-gray-800">${pending}</div>
                    <div class="text-xs text-gray-500">รอดำเนินการ</div>
                </div>

                <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                    <div class="w-8 h-8 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center mb-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    </div>
                    <div class="text-2xl font-bold text-gray-800">${process}</div>
                    <div class="text-xs text-gray-500">กำลังทำ</div>
                </div>

                <div class="col-span-2 bg-green-50 rounded-2xl p-4 border border-green-100 flex items-center justify-between">
                    <div>
                        <div class="text-green-800 font-bold text-xl">${done}</div>
                        <div class="text-green-600 text-xs text-nowrap">เสร็จสิ้น</div>
                    </div>
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                </div>
            `;
        }

        // Helper to format date for dashboard calendar icon
        function formatDateShort(dateStr) {
            if (!dateStr) return { day: '-', month: '-' };
            const date = new Date(dateStr);
            const day = date.getDate();
            // Thai months abbr
            const months = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
            const month = months[date.getMonth()];
            return { day, month };
        } const COOP_NAMES = [
            'สหกรณ์กองทุนสวนยางบ้านสหมิตร จำกัด',
            'สหกรณ์การเกษตรเมืองระยอง จำกัด',
            'สหกรณ์การเกษตรศรีเมืองระยอง จำกัด',
            'สหกรณ์เครดิตยูเนี่ยน ชุมชนมาบตาพุดร่วมใจ จำกัด',
            'สหกรณ์บริการไออาร์พีซี จำกัด',
            'สหกรณ์ออมทรัพย์ครูระยอง จำกัด',
            'สหกรณ์ออมทรัพย์ตำรวจภูธรจังหวัดระยอง จำกัด',
            'สหกรณ์ออมทรัพย์พนักงานโคเวสโตรมาบตาพุด จำกัด',
            'สหกรณ์ออมทรัพย์พนักงานไออาร์พีซี จำกัด',
            'สหกรณ์ออมทรัพย์โรงพยาบาลระยอง จำกัด',
            'สหกรณ์ออมทรัพย์สาธารณสุขระยอง จำกัด',
            'สหกรณ์กองทุนสวนยางพัฒนาบ้านท่าเสา จำกัด',
            'สหกรณ์การเกษตรบ้านฉาง จำกัด',
            'สหกรณ์การเกษตรผู้เลี้ยงสัตว์ระยอง จำกัด',
            'สหกรณ์เดินรถระยองสามัคคี จำกัด',
            'สหกรณ์บริการเดินรถรวมใจ จำกัด',
            'สหกรณ์บริการเทศบาลตำบลบ้านฉาง จำกัด',
            'สหกรณ์บริการระยองยั่งยืน จำกัด',
            'สหกรณ์ออมทรัพย์ อูเบะ (ประเทศไทย) จำกัด',
            'สหกรณ์ออมทรัพย์ในเครือร่วมเจริญ จำกัด',
            'สหกรณ์ออมทรัพย์พนักงานสัมพันธ์ไออาร์พีซี จำกัด',
            'สหกรณ์กองทุนสวนยางบ้านเนินสว่าง จำกัด',
            'สหกรณ์เครดิตยูเนี่ยนเกาะกกหนองแตงเมร่วมใจ จำกัด',
            'สหกรณ์บริการเดินรถบ้านค่ายระยอง จำกัด',
            'สหกรณ์ออมทรัพย์กลุ่มอินโดรามา (2019) จำกัด',
            'สหกรณ์ออมทรัพย์พนักงานในเครือบริษัทไทยโพลีอะซีทัลและบริษัทไทยโพลีคาร์บอเนต จำกัด',
            'สหกรณ์ออมทรัพย์พนักงานบริษัทอินโดรามา ปิโตรเคม จำกัด',
            'สหกรณ์ออมทรัพย์เอ็นพีซีระยอง จำกัด',
            'สหกรณ์บริการเดินรถตาขัน จำกัด',
            'สหกรณ์บริการกองบินทหารเรือ จำกัด',
            'สหกรณ์เครดิตยูเนี่ยนชุมชนแหลมรุ่งเรืองระยอง จำกัด',
            'สหกรณ์เครดิตยูเนี่ยนบ้านไร่จันดี จำกัด',
            'สหกรณ์เดินรถระยอง จำกัด',
            'สหกรณ์บริการเดินรถปากน้ำระยอง จำกัด',
            'สหกรณ์บริการเดินรถระยองรวมรถ จำกัด',
            'สหกรณ์ประมงบ้านเพ จำกัด',
            'สหกรณ์ประมงระยอง จำกัด',
            'สหกรณ์กองทุนสวนยางบ้านชุมนุมสูง จำกัด',
            'สหกรณ์การเกษตรเขาชะเมา จำกัด',
            'สหกรณ์การเกษตรเมืองแกลง จำกัด',
            'สหกรณ์การเกษตรบ้านน้ำเป็น จำกัด',
            'สหกรณ์กองทุนสวนยางตำบลชำฆ้อ จำกัด',
            'สหกรณ์การเกษตรทุ่งควายกิน จำกัด',
            'สหกรณ์การเกษตรบ้านค่าย จำกัด',
            'สหกรณ์เครดิตยูเนี่ยนอาโอยาม่าไทย จำกัด',
            'สหกรณ์เครดิตยูเนี่ยน เอเอที จำกัด',
            'สหกรณ์เครดิตยูเนี่ยนชุมชนละหาร จำกัด',
            'สหกรณ์เครดิตยูเนี่ยนเอฟ ที เอ็ม จำกัด',
            'สหกรณ์บริการดอกกราย จำกัด',
            'สหกรณ์บริการอัทสุมิเท็ค จำกัด',
            'สหกรณ์บริการแอเดียนท์ แอนด์ ซัมมิท คอร์ปอเรชั่น จำกัด',
            'ชุมนุมสหกรณ์จังหวัดระยอง จำกัด',
            'สหกรณ์การเกษตรปลวกแดง จำกัด',
            'สหกรณ์ออมทรัพย์อุตสาหกรรมถุงพลาสติกไทย และเอเปคฟิล์ม จำกัด',
            'สหกรณ์ออมทรัพย์มิตซุย ไฮยีน แมททีเรียลส์ (ประเทศไทย) จำกัด',
            'สหกรณ์หมู่บ้านพัฒนาผัง 2 ดอกกราย จำกัด',
            'สหกรณ์เดินรถพนานิคม จำกัด',
            'สหกรณ์เคหสถานบ้านก้าวมั่นคง จำกัด',
            'สหกรณ์การเกษตรนิคมฯ ระยอง จำกัด',
            'สหกรณ์ออมทรัพย์มิตซูบิชิ อิเลคทริคไทย ออโต้-พาร์ท จำกัด',
            'สหกรณ์ออมทรัพย์สหภาพแรงงานอุตสาหกรรมท่อเหล็ก จำกัด',
            'สหกรณ์ออมทรัพย์พนักงานบริษัทโตไก อีสเทิร์น รับเบอร์ (ประเทศไทย) จำกัด',
            'สหกรณ์ออมทรัพย์พนักงานเซนต์โกเบน จำกัด',
            'สหกรณ์ออมทรัพย์มิกาซ่า จำกัด',
            'สหกรณ์เครดิตยูเนี่ยนยานากาว่า จำกัด',
            'สหกรณ์เครดิตยูเนี่ยนสยามโกชิ จำกัด',
            'สหกรณ์กองทุนสวนยางปลวกแดง จำกัด',
            'สหกรณ์ออมทรัพย์ไดกิ้นคอมเพรสเซอร์ อินดัสทรี้ส์ จำกัด',
            'สหกรณ์ออมทรัพย์ชูโอไทย จำกัด',
            'สหกรณ์ออมทรัพย์ไทยเปเปอร์มิลล์ จำกัด',
            'สหกรณ์ออมทรัพย์พนักงานคาวาซากิ จำกัด',
            'สหกรณ์ออมทรัพย์ซังโกะไทย จำกัด',
            'สหกรณ์เครดิตยูเนี่ยนยามาดะสมบูรณ์ จำกัด',
            'สหกรณ์เครดิตยูเนี่ยนสหภาพแรงงานซูมิโตโม่ รับเบอร์ จำกัด',
            'สหกรณ์เคหสถานบ้านมั่นคงสาย 11 จำกัด',
            'สหกรณ์นิคมชุมแสงจันทร์ จำกัด',
            'สหกรณ์นิคมวังไทร จำกัด',
            'สหกรณ์นิคมเขาพนมสาร์ท จำกัด',
            'สหกรณ์นิคมป่ายุบใน จำกัด',
            'สหกรณ์การเกษตรเพื่อการตลาดลูกค้า ธ.ก.ส.ระยอง จำกัด',
            'กลุ่มเกษตรกรทำสวนยางพาราบางบุตร',
            'กลุ่มเกษตรกรทำนาเชิงเนิน',
            'กลุ่มเกษตรกรทำสวนสำนักท้อน',
            'กลุ่มเกษตรกรทำประมงปากน้ำระยอง',
            'กลุ่มเกษตรกรทำไร่สับปะรดตำบลสำนักท้อน',
            'กลุ่มเกษตรกรทำสวนชากบก',
            'กลุ่มเกษตรกรทำนาทางเกวียน',
            'กลุ่มเกษตรกรทำสวนเขาน้อย',
            'กลุ่มเกษตรกรทำสวนชุมแสง',
            'กลุ่มเกษตรกรทำสวนบ้านนา',
            'กลุ่มเกษตรกรทำสวนวังหว้า',
            'กลุ่มเกษตรกรปลูกสับปะรดทางเกวียน',
            'กลุ่มเกษตรกรทำไร่สับปะรดตำบลชำฆ้อ',
            'กลุ่มเกษตรกรทำสวนน้ำเป็น',
            'กลุ่มเกษตรกรทำสวนบ้านชากพงรวมปัญญา',
            'กลุ่มเกษตรกรทำสวนป่ายุบใน',
            'กลุ่มเกษตรกรทำสวนทุ่งควายกิน',
            'กลุ่มเกษตรกรทำสวนห้วยทับมอญ',
            'กลุ่มเกษตรกรทำไร่ละหาร',
            'กลุ่มเกษตรกรทำไร่สับปะรดพนานิคม',
            'กลุ่มเกษตรกรทำไร่สับปะรดตำบลปลวกแดง',
            'กลุ่มเกษตรกรทำนาบ้านค่าย',
            'กลุ่มเกษตรกรทำนาบางบุตร',
            'กลุ่มเกษตรกรทำไร่แม่น้ำคู้',
            'กลุ่มเกษตรกรทำไร่สับปะรดมะขามคู่',
            'กลุ่มเกษตรกรทำไร่นิคมพัฒนา',
            'กลุ่มเกษตรกรทำไร่มาบยางพร',
            'กลุ่มเกษตรกรทำไร่มาบข่า',
            'กลุ่มเกษตรกรคนพิการผู้เลี้ยงแพะตำบลพังราด',
            'กลุ่มเกษตรกรผู้ปลูกสับปะรดตำบลหนองไร่',
            'กลุ่มเกษตรกรทำสวนตำบลตาสิทธิ์'
        ];

        // Initialize datalist on page load
        function initCoopNamesList() {
            const datalist = document.getElementById('coop-names-list');
            datalist.innerHTML = COOP_NAMES.map(name => `<option value="${name}">`).join('');
        }

        // ==================== UTILITY FUNCTIONS ====================

        /**
         * Calculate working days between two dates
         * Excludes weekends (Sat/Sun) and Thai public holidays
         */
        function calculateWorkingDays(startDate, endDate) {
            if (!startDate || !endDate) return null;

            const start = new Date(startDate);
            const end = new Date(endDate);

            if (start > end) return null;

            let workingDays = 0;
            const current = new Date(start);

            // เริ่มนับจากวันถัดไป (ไม่รวมวันที่รับ)
            current.setDate(current.getDate() + 1);

            while (current <= end) {
                const dayOfWeek = current.getDay();
                const dateStr = current.toISOString().split('T')[0];

                // Skip weekends (0 = Sunday, 6 = Saturday) and public holidays
                if (dayOfWeek !== 0 && dayOfWeek !== 6 && !PUBLIC_HOLIDAYS.includes(dateStr)) {
                    workingDays++;
                }

                current.setDate(current.getDate() + 1);
            }

            return workingDays;
        }

        /**
         * Format date string to Thai format
         */
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        /**
         * Show/hide loading overlay
         */
        function showLoading(show = true) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        /**
         * Show toast notification
         */
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');

            toastMessage.textContent = message;

            if (type === 'error') {
                toastIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>';
                toast.querySelector('div').classList.remove('bg-gray-800');
                toast.querySelector('div').classList.add('bg-red-600');
            } else {
                toastIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>';
                toast.querySelector('div').classList.remove('bg-red-600');
                toast.querySelector('div').classList.add('bg-gray-800');
            }

            toast.classList.remove('translate-y-20', 'opacity-0');

            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // ==================== API FUNCTIONS ====================

        /**
         * Fetch all records from backend
         */
        async function fetchAllRecords() {
            try {
                showLoading(true);
                const response = await fetch(`${SCRIPT_URL}?action=getAll`, {
                    redirect: 'follow'
                });
                const result = await response.json();

                if (result.success) {
                    allRecords = result.data;
                    applyFiltersAndRender();
                    updateSummary();
                } else {
                    showToast('เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error fetching records:', error);
                showToast('ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้', 'error');
                renderEmptyState();
            } finally {
                showLoading(false);
            }
        }

        /**
         * Create new record
         */
        async function createRecord(recordData) {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                redirect: 'follow',
                body: JSON.stringify({ action: 'create', record: recordData })
            });
            return await response.json();
        }

        /**
         * Create multiple records
         */
        async function createRecordBatch(records) {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                redirect: 'follow',
                body: JSON.stringify({ action: 'createBatch', records: records })
            });
            return await response.json();
        }

        /**
         * Update existing record
         */
        async function updateRecord(recordData) {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                redirect: 'follow',
                body: JSON.stringify({ action: 'update', record: recordData })
            });
            return await response.json();
        }

        /**
         * Delete record
         */
        async function deleteRecordApi(id) {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                redirect: 'follow',
                body: JSON.stringify({ action: 'delete', id: id })
            });
            return await response.json();
        }

        /**
         * Upload file
         */
        async function uploadFileApi(fileData, fileName, mimeType, cooperativeName) {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                redirect: 'follow',
                body: JSON.stringify({
                    action: 'uploadFile',
                    fileData,
                    fileName,
                    mimeType,
                    cooperativeName
                })
            });
            return await response.json();
        }

        /**
         * Delete file
         */
        async function deleteFileApi(fileId) {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                redirect: 'follow',
                body: JSON.stringify({ action: 'deleteFile', fileId })
            });
            return await response.json();
        }

        // ==================== UI FUNCTIONS ====================

        function createDocItemRow(type = '', topic = '') {
            const div = document.createElement('div');
            div.className = 'doc-item-row grid grid-cols-1 md:grid-cols-2 gap-4 p-3 bg-gray-50 rounded-lg border border-gray-200 relative';
            div.innerHTML = `
                <div>
                     <label class="block text-xs font-medium text-gray-500 mb-1">ประเภทเอกสาร</label>
                     <select class="doc-type w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="">เลือกประเภท</option>
                        <option value="ระเบียบ" ${type === 'ระเบียบ' ? 'selected' : ''}>ระเบียบ</option>
                        <option value="ข้อบังคับ" ${type === 'ข้อบังคับ' ? 'selected' : ''}>ข้อบังคับ</option>
                     </select>
                </div>
                <div>
                     <label class="block text-xs font-medium text-gray-500 mb-1">หัวข้อ</label>
                     <input type="text" class="doc-topic w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ระบุหัวข้อ" value="${topic}" required>
                </div>
                <button type="button" class="btn-remove-doc-item absolute -top-2 -right-2 bg-red-100 text-red-500 rounded-full p-1 shadow-sm hover:bg-red-200 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            `;

            // Remove button event
            div.querySelector('.btn-remove-doc-item').addEventListener('click', () => {
                const container = document.getElementById('doc-items-container');
                if (container.children.length > 1) {
                    div.remove();
                } else {
                    showToast('ต้องมีรายการเอกสารอย่างน้อย 1 รายการ', 'error');
                }
            });

            return div;
        }

        function showModal() {
            document.getElementById('modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function hideModal() {
            document.getElementById('modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function showDeleteModal(record) {
            recordToDelete = record;
            document.getElementById('delete-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function hideDeleteModal() {
            recordToDelete = null;
            document.getElementById('delete-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function updateCoopDaysInfo() {
            const startDate = document.getElementById('input-receive-coop').value;
            const endDate = document.getElementById('input-send-coop').value;
            const infoDiv = document.getElementById('coop-days-info');

            if (startDate && endDate) {
                const days = calculateWorkingDays(startDate, endDate);
                if (days !== null) {
                    infoDiv.textContent = `📅 จำนวนวันทำการ: ${days} วัน (ไม่นับวันหยุดราชการและเสาร์-อาทิตย์)`;
                    infoDiv.classList.remove('hidden');
                } else {
                    infoDiv.classList.add('hidden');
                }
            } else {
                infoDiv.classList.add('hidden');
            }
        }

        function updateGroupDaysInfo() {
            const startDate = document.getElementById('input-receive-admin').value;
            const endDate = document.getElementById('input-group-complete').value;
            const infoDiv = document.getElementById('group-days-info');

            if (startDate && endDate) {
                const days = calculateWorkingDays(startDate, endDate);
                if (days !== null) {
                    infoDiv.textContent = `📅 กลุ่มใช้เวลาดำเนินการ: ${days} วันทำการ`;
                    infoDiv.classList.remove('hidden');
                } else {
                    infoDiv.classList.add('hidden');
                }
            } else {
                infoDiv.classList.add('hidden');
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();

            const saveBtn = document.getElementById('btn-save');
            const spinner = document.getElementById('save-spinner');
            saveBtn.disabled = true;
            spinner.classList.remove('hidden');

            const coopName = document.getElementById('input-coop-name').value.trim();

            try {
                // Initialize common record data
                const baseRecordData = {
                    cooperative_name: coopName,
                    receive_from_coop_date: document.getElementById('input-receive-coop').value || '',
                    send_back_to_coop_date: document.getElementById('input-send-coop').value || '',
                    receive_from_admin_date: document.getElementById('input-receive-admin').value || '',
                    group_complete_date: document.getElementById('input-group-complete').value || '',
                    status: document.getElementById('input-status').value,
                    notes: document.getElementById('input-notes').value.trim()
                };

                // Gather Document Items
                const docItems = document.querySelectorAll('.doc-item-row');
                const recordsToSave = [];

                docItems.forEach(row => {
                    recordsToSave.push({
                        ...baseRecordData,
                        document_type: row.querySelector('.doc-type').value,
                        document_topic: row.querySelector('.doc-topic').value.trim()
                    });
                });

                // Handle file upload if exists
                if (selectedFile) {
                    showLoading(true); // Ensure loading is shown

                    // Convert file to Base64
                    const fileReader = new FileReader();
                    const base64Promise = new Promise((resolve, reject) => {
                        fileReader.onload = () => resolve(fileReader.result.split(',')[1]);
                        fileReader.onerror = reject;
                        fileReader.readAsDataURL(selectedFile);
                    });

                    const base64Data = await base64Promise;

                    // Show progress UI (simulated)
                    document.getElementById('upload-progress').classList.remove('hidden');
                    document.getElementById('progress-bar').style.width = '100%';
                    document.getElementById('progress-text').textContent = 'กำลังอัพโหลด...';

                    // Upload to Drive
                    const uploadResult = await uploadFileApi(base64Data, selectedFile.name, selectedFile.type, coopName);

                    if (uploadResult.success) {
                        // Add attachment info to base record data
                        baseRecordData.attachment_file_id = uploadResult.data.fileId;
                        baseRecordData.attachment_file_name = uploadResult.data.fileName;
                        baseRecordData.attachment_file_url = uploadResult.data.fileUrl;

                        // If we had a previous file and we are editing, we might want to delete it?
                        // For now, let's just replace the reference.
                        // Future improvement: delete old file if replaced.
                    } else {
                        throw new Error('Upload failed: ' + uploadResult.error);
                    }
                } else if (currentAttachment) {
                    // Keep existing attachment info
                    recordData.attachment_file_id = currentAttachment.id;
                    recordData.attachment_file_name = currentAttachment.name;
                    recordData.attachment_file_url = currentAttachment.url;
                }

                const recordId = document.getElementById('record-id').value;
                let result;

                // Handle Attachment for ALL records
                // If creating multiple records, they all get the same attachment reference
                recordsToSave.forEach(record => {
                    if (selectedFile) {
                        record.attachment_file_id = baseRecordData.attachment_file_id;
                        record.attachment_file_name = baseRecordData.attachment_file_name;
                        record.attachment_file_url = baseRecordData.attachment_file_url;
                    } else if (currentAttachment) {
                        record.attachment_file_id = currentAttachment.id;
                        record.attachment_file_name = currentAttachment.name;
                        record.attachment_file_url = currentAttachment.url;
                    }
                });

                if (isEditing && recordId) {
                    // Edit Mode: Update single record (take the first item, as edit mode forces 1 item)
                    const recordData = recordsToSave[0];
                    recordData.id = recordId;
                    result = await updateRecord(recordData);
                } else {
                    // Create Mode: Batch or Single
                    if (recordsToSave.length > 1) {
                        result = await createRecordBatch(recordsToSave);
                    } else {
                        result = await createRecord(recordsToSave[0]);
                    }
                }

                if (result && result.success) {
                    showToast(isEditing ? 'แก้ไขรายการสำเร็จ' : 'เพิ่มรายการสำเร็จ', 'success');
                    hideModal();
                    await fetchAllRecords();
                } else {
                    showToast('เกิดข้อผิดพลาด: ' + (result.error || 'กรุณาลองใหม่'), 'error');
                }
            } catch (err) {
                console.error('Error saving record:', err);
                showToast('เกิดข้อผิดพลาด: ' + err.message, 'error');
            } finally {
                saveBtn.disabled = false;
                spinner.classList.add('hidden');
                document.getElementById('upload-progress').classList.add('hidden');
                showLoading(false);
            }
        }

        function editRecord(record) {
            isEditing = true;
            document.getElementById('modal-title').textContent = 'แก้ไขรายการ';
            document.getElementById('record-id').value = record.id;
            document.getElementById('input-coop-name').value = record.cooperative_name || '';

            // Setup Doc Items for Edit
            const container = document.getElementById('doc-items-container');
            container.innerHTML = '';
            container.appendChild(createDocItemRow(record.document_type || '', record.document_topic || ''));

            // Hide Add/Remove buttons in Edit Mode
            document.getElementById('btn-add-doc-item').classList.add('hidden');
            container.querySelectorAll('.btn-remove-doc-item').forEach(btn => btn.classList.add('hidden'));

            document.getElementById('input-receive-coop').value = record.receive_from_coop_date || '';
            document.getElementById('input-send-coop').value = record.send_back_to_coop_date || '';
            document.getElementById('input-receive-admin').value = record.receive_from_admin_date || '';
            document.getElementById('input-group-complete').value = record.group_complete_date || '';
            document.getElementById('input-status').value = record.status || 'รอดำเนินการ';
            updateCoopDaysInfo();
            updateGroupDaysInfo();

            // Handle Attachment
            selectedFile = null;
            resetFileUploadUI();

            if (record.attachment_file_id) {
                currentAttachment = {
                    id: record.attachment_file_id,
                    name: record.attachment_file_name,
                    url: record.attachment_file_url
                };
                showCurrentAttachment(currentAttachment);
            } else {
                currentAttachment = null;
                document.getElementById('current-attachment').classList.add('hidden');
            }

            showModal();
        }

        async function confirmDelete() {
            if (!recordToDelete) return;

            const deleteBtn = document.getElementById('btn-confirm-delete');
            const spinner = document.getElementById('delete-spinner');
            deleteBtn.disabled = true;
            spinner.classList.remove('hidden');

            try {
                const result = await deleteRecordApi(recordToDelete.id);
                if (result && result.success) {
                    showToast('ลบรายการสำเร็จ', 'success');
                    hideDeleteModal();
                    await fetchAllRecords();
                } else {
                    showToast('เกิดข้อผิดพลาดในการลบ: ' + (result.error || ''), 'error');
                }
            } catch (err) {
                console.error('Error deleting record:', err);
                showToast('เกิดข้อผิดพลาดในการลบ', 'error');
            }

            deleteBtn.disabled = false;
            spinner.classList.add('hidden');
        }

        function applyFiltersAndRender() {
            const searchTerm = document.getElementById('filter-search').value.toLowerCase();
            const typeFilter = document.getElementById('filter-type').value;
            const statusFilter = document.getElementById('filter-status').value;

            filteredRecords = allRecords.filter(record => {
                const matchSearch = !searchTerm ||
                    (record.cooperative_name || '').toLowerCase().includes(searchTerm) ||
                    (record.document_topic || '').toLowerCase().includes(searchTerm);
                const matchType = !typeFilter || record.document_type === typeFilter;
                const matchStatus = !statusFilter || record.status === statusFilter;
                return matchSearch && matchType && matchStatus;
            });

            // Sort by created_at descending
            filteredRecords.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));

            // Reset to first page when filters change
            currentPage = 1;

            renderTableWithPagination();
        }

        // ==================== PAGINATION FUNCTIONS ====================

        function renderTableWithPagination() {
            const totalRecords = filteredRecords.length;
            const totalPages = Math.ceil(totalRecords / pageSize);

            // Ensure currentPage is within bounds
            if (currentPage > totalPages) currentPage = totalPages || 1;
            if (currentPage < 1) currentPage = 1;

            // Calculate start and end indices
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, totalRecords);

            // Get records for current page
            const pageRecords = filteredRecords.slice(startIndex, endIndex);

            // Render table with page records (pass startIndex for correct numbering)
            renderTable(pageRecords, startIndex);

            // Update pagination UI
            updatePaginationUI(totalRecords, totalPages, startIndex, endIndex);
        }

        function updatePaginationUI(totalRecords, totalPages, startIndex, endIndex) {
            const paginationContainer = document.getElementById('pagination-container');

            if (totalRecords === 0) {
                paginationContainer.classList.add('hidden');
                return;
            }

            paginationContainer.classList.remove('hidden');

            // Update info text
            document.getElementById('pagination-info').textContent =
                `รายการ ${startIndex + 1}-${endIndex} จาก ${totalRecords}`;

            // Update page numbers
            document.getElementById('current-page').textContent = currentPage;
            document.getElementById('total-pages').textContent = totalPages;

            // Update button states
            const btnFirst = document.getElementById('btn-first-page');
            const btnPrev = document.getElementById('btn-prev-page');
            const btnNext = document.getElementById('btn-next-page');
            const btnLast = document.getElementById('btn-last-page');

            btnFirst.disabled = currentPage === 1;
            btnPrev.disabled = currentPage === 1;
            btnNext.disabled = currentPage === totalPages;
            btnLast.disabled = currentPage === totalPages;
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredRecords.length / pageSize);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderTableWithPagination();
        }

        function changePageSize(newSize) {
            pageSize = parseInt(newSize);
            currentPage = 1; // Reset to first page
            renderTableWithPagination();
        }

        function clearFilters() {
            document.getElementById('filter-search').value = '';
            document.getElementById('filter-type').value = '';
            document.getElementById('filter-status').value = '';
            applyFiltersAndRender();
        }

        function renderEmptyState() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = `
        <tr>
          <td colspan="12" class="px-4 py-12 text-center text-gray-500">
            <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <p>ยังไม่มีรายการ กดปุ่ม "เพิ่มรายการใหม่" เพื่อเริ่มต้น</p>
          </td>
        </tr>
      `;
        }

        function renderTable(records, startIndex = 0) {
            const tbody = document.getElementById('table-body');

            if (records.length === 0) {
                tbody.innerHTML = `
          <tr>
            <td colspan="12" class="px-4 py-12 text-center text-gray-500">
              <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              <p>ไม่พบรายการที่ตรงกับเงื่อนไข</p>
            </td>
          </tr>
        `;
                return;
            }

            tbody.innerHTML = records.map((record, index) => {
                const coopDays = calculateWorkingDays(record.receive_from_coop_date, record.send_back_to_coop_date);
                const groupDays = calculateWorkingDays(record.receive_from_admin_date, record.group_complete_date);

                let statusClass = 'status-pending';
                if (record.status === 'ดำเนินการแล้ว') statusClass = 'status-complete';
                else if (record.status === 'กำลังดำเนินการ') statusClass = 'status-processing';

                let rowClass = '';
                if (record.status === 'ดำเนินการแล้ว') rowClass = 'row-complete';
                else if (record.status === 'กำลังดำเนินการ') rowClass = 'row-processing';
                else rowClass = 'row-pending';

                return `
          <tr class="table-row ${rowClass} transition-colors" data-id="${record.id}">
            <td class="px-4 py-3 text-sm text-gray-600">${startIndex + index + 1}</td>
            <td class="px-4 py-3 text-sm font-medium text-gray-800">${record.cooperative_name || '-'}</td>
            <td class="px-4 py-3 text-sm">
              <span class="px-2 py-1 rounded whitespace-nowrap ${record.document_type === 'ระเบียบ' ? 'bg-white text-blue-700 border border-blue-200' : 'bg-white text-purple-700 border border-purple-200'}">
                ${record.document_type || '-'}
              </span>
            </td>
            <td class="px-4 py-3 text-sm text-gray-600">${record.document_topic || '-'}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${formatDate(record.receive_from_coop_date)}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${formatDate(record.send_back_to_coop_date)}</td>
            <td class="px-4 py-3 text-sm text-center font-semibold ${coopDays !== null ? 'text-blue-600' : 'text-gray-400'}">${coopDays !== null ? coopDays + ' วัน' : '-'}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${formatDate(record.receive_from_admin_date)}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${formatDate(record.group_complete_date)}</td>
            <td class="px-4 py-3 text-sm text-center font-semibold ${groupDays !== null ? 'text-green-600' : 'text-gray-400'}">${groupDays !== null ? groupDays + ' วัน' : '-'}</td>
            <td class="px-4 py-3 text-sm">
              <span class="px-2 py-1 rounded text-xs font-medium whitespace-nowrap ${statusClass} shadow-sm border border-opacity-20 border-gray-400">${record.status || '-'}</span>
            </td>
            <td class="px-4 py-3 text-sm">
                ${record.attachment_file_url ?
                        `<a href="${record.attachment_file_url}" target="_blank" class="text-blue-600 hover:text-blue-800 flex items-center gap-1 group">
                        <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                        เปิดไฟล์
                    </a>` :
                        '<span class="text-gray-400">-</span>'
                    }
            </td>
            <td class="px-4 py-3 text-sm">
              <div class="flex gap-1">
                <button onclick="editRecord(allRecords.find(r => r.id === '${record.id}'))" class="p-1.5 text-blue-600 hover:bg-blue-200 rounded transition-colors bg-white/50" title="แก้ไข">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                </button>
                <button onclick="showDeleteModal(allRecords.find(r => r.id === '${record.id}'))" class="p-1.5 text-red-600 hover:bg-red-200 rounded transition-colors bg-white/50" title="ลบ">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
                    `;
            }).join('');
        }



        function updateSummary() {
            const summarySection = document.getElementById('summary-section');
            const summaryContent = document.getElementById('summary-content');

            if (allRecords.length === 0) {
                summarySection.classList.add('hidden');
                return;
            }

            summarySection.classList.remove('hidden');

            // Group by cooperative
            const groupedByCooperative = {};
            allRecords.forEach(record => {
                const coopName = (record.cooperative_name || 'ไม่ระบุชื่อ').replace(/\s+/g, ' ').trim();
                if (!groupedByCooperative[coopName]) {
                    groupedByCooperative[coopName] = {
                        ระเบียบ: [],
                        ข้อบังคับ: []
                    };
                }
                if (record.document_type === 'ระเบียบ' || record.document_type === 'ข้อบังคับ') {
                    groupedByCooperative[coopName][record.document_type].push(record);
                }
            });

            let html = '';
            Object.keys(groupedByCooperative).sort().forEach(coopName => {
                const docs = groupedByCooperative[coopName];
                const totalDocs = docs['ระเบียบ'].length + docs['ข้อบังคับ'].length;

                html += `
          <div class="border border-gray-200 rounded-lg p-4">
            <h4 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
              <span class="w-8 h-8 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center text-sm font-bold">${totalDocs}</span>
              ${coopName}
            </h4>
            <div class="grid grid-cols-1 gap-4">
        `;

                if (docs['ระเบียบ'].length > 0) {
                    html += `
            <div class="bg-blue-50 rounded-lg p-3">
              <h5 class="font-medium text-blue-800 mb-2">📋 ระเบียบ (${docs['ระเบียบ'].length})</h5>
              <ul class="space-y-1 text-sm text-blue-700 break-words">
                ${docs['ระเบียบ'].map(d => {
                        let color = 'text-yellow-600';
                        if (d.status === 'ดำเนินการแล้ว') color = 'text-green-600';
                        else if (d.status === 'กำลังดำเนินการ') color = 'text-blue-600';
                        return `<li class="${color}">• ${d.document_topic || 'ไม่ระบุหัวข้อ'}</li>`;
                    }).join('')}
              </ul>
            </div>
          `;
                }

                if (docs['ข้อบังคับ'].length > 0) {
                    html += `
            <div class="bg-purple-50 rounded-lg p-3">
              <h5 class="font-medium text-purple-800 mb-2">📜 ข้อบังคับ (${docs['ข้อบังคับ'].length})</h5>
              <ul class="space-y-1 text-sm text-purple-700 break-words">
                ${docs['ข้อบังคับ'].map(d => {
                        let color = 'text-yellow-600';
                        if (d.status === 'ดำเนินการแล้ว') color = 'text-green-600';
                        else if (d.status === 'กำลังดำเนินการ') color = 'text-blue-600';
                        return `<li class="${color}">• ${d.document_topic || 'ไม่ระบุหัวข้อ'}</li>`;
                    }).join('')}
              </ul>
            </div>
          `;
                }

                html += `
            </div>
          </div >
        `;
            });

            summaryContent.innerHTML = html;
        }

        // ==================== EVENT LISTENERS ====================

        function setupEventListeners() {
            // Add new button
            document.getElementById('btn-add-new').addEventListener('click', () => {
                isEditing = false;
                document.getElementById('modal-title').textContent = 'เพิ่มรายการใหม่';
                document.getElementById('form-record').reset();
                document.getElementById('record-id').value = '';
                document.getElementById('coop-days-info').classList.add('hidden');
                document.getElementById('group-days-info').classList.add('hidden');

                // Reset file upload
                selectedFile = null;
                currentAttachment = null;
                resetFileUploadUI();
                document.getElementById('current-attachment').classList.add('hidden');

                showModal();

                // Initialize Doc Items for New Record
                const container = document.getElementById('doc-items-container');
                container.innerHTML = '';
                container.appendChild(createDocItemRow()); // Add one empty row
                document.getElementById('btn-add-doc-item').classList.remove('hidden');
            });

            // Add Doc Item Button
            document.getElementById('btn-add-doc-item').addEventListener('click', () => {
                const container = document.getElementById('doc-items-container');
                container.appendChild(createDocItemRow());
            });

            // Modal close buttons
            document.getElementById('btn-close-modal').addEventListener('click', hideModal);
            document.getElementById('btn-cancel').addEventListener('click', hideModal);
            document.getElementById('modal-backdrop').addEventListener('click', hideModal);

            // Form submit
            document.getElementById('form-record').addEventListener('submit', handleFormSubmit);
            document.getElementById('form-daily-op').addEventListener('submit', handleDailyOpSubmit); // NEW

            // Date change listeners for auto-calculation and synchronization
            document.getElementById('input-receive-coop').addEventListener('change', updateCoopDaysInfo);

            document.getElementById('input-send-coop').addEventListener('change', function () {
                updateCoopDaysInfo();
                // Sync to Group Completed Date
                document.getElementById('input-group-complete').value = this.value;
                updateGroupDaysInfo();
            });

            document.getElementById('input-receive-admin').addEventListener('change', updateGroupDaysInfo);

            document.getElementById('input-group-complete').addEventListener('change', function () {
                updateGroupDaysInfo();
                // Sync to Returned to Cooperative Date
                document.getElementById('input-send-coop').value = this.value;
                updateCoopDaysInfo();
            });

            // Filters
            document.getElementById('filter-search').addEventListener('input', applyFiltersAndRender);
            document.getElementById('filter-type').addEventListener('change', applyFiltersAndRender);
            document.getElementById('filter-status').addEventListener('change', applyFiltersAndRender);
            document.getElementById('btn-clear-filter').addEventListener('click', clearFilters);

            // Daily Ops Filters
            document.getElementById('daily-filter-date').addEventListener('change', renderDailyOpsTable);

            // Pagination
            document.getElementById('page-size').addEventListener('change', (e) => changePageSize(e.target.value));
            document.getElementById('btn-first-page').addEventListener('click', () => goToPage(1));
            document.getElementById('btn-prev-page').addEventListener('click', () => goToPage(currentPage - 1));
            document.getElementById('btn-next-page').addEventListener('click', () => goToPage(currentPage + 1));
            document.getElementById('btn-last-page').addEventListener('click', () => {
                const totalPages = Math.ceil(filteredRecords.length / pageSize);
                goToPage(totalPages);
            });

            // Delete modal
            document.getElementById('btn-cancel-delete').addEventListener('click', hideDeleteModal);
            document.getElementById('btn-confirm-delete').addEventListener('click', confirmDelete);

            // File Upload Listeners
            setupFileUploadListeners();
        }

        function setupFileUploadListeners() {
            const dropZone = document.getElementById('file-drop-zone');
            const fileInput = document.getElementById('file-input');
            const btnCancelUpload = document.getElementById('btn-cancel-upload');
            const btnRemoveAttachment = document.getElementById('btn-remove-attachment');

            // Handling drag and drop events
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            dropZone.addEventListener('dragenter', () => dropZone.classList.add('border-blue-500', 'bg-blue-50'));
            dropZone.addEventListener('dragover', () => dropZone.classList.add('border-blue-500', 'bg-blue-50'));
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-blue-500', 'bg-blue-50'));
            dropZone.addEventListener('drop', (e) => {
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            });

            // Click to select
            dropZone.addEventListener('click', (e) => {
                if (e.target !== btnCancelUpload) fileInput.click();
            });

            fileInput.addEventListener('change', function () {
                handleFiles(this.files);
            });

            btnCancelUpload.addEventListener('click', (e) => {
                e.stopPropagation();
                selectedFile = null;
                fileInput.value = '';
                resetFileUploadUI();
            });

            btnRemoveAttachment.addEventListener('click', async () => {
                if (confirm('คุณต้องการลบไฟล์แนบนี้หรือไม่?')) {
                    if (currentAttachment && currentAttachment.id) {
                        // Optional: Call API to delete file from Drive immediately
                        // For now we just remove reference
                    }
                    currentAttachment = null;
                    document.getElementById('current-attachment').classList.add('hidden');
                    document.getElementById('file-drop-zone').classList.remove('hidden');
                }
            });
        }

        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                // Validate file size (10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showToast('ขนาดไฟล์ต้องไม่เกิน 10MB', 'error');
                    return;
                }

                selectedFile = file;
                displaySelectedFile(file);
            }
        }

        function displaySelectedFile(file) {
            const dropZoneContent = document.getElementById('drop-zone-content');
            const fileDisplay = document.getElementById('selected-file-display');
            const fileName = document.getElementById('selected-file-name');
            const fileSize = document.getElementById('selected-file-size');

            dropZoneContent.classList.add('hidden');
            fileDisplay.classList.remove('hidden');

            fileName.textContent = file.name;
            fileSize.textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
        }

        function resetFileUploadUI() {
            const dropZoneContent = document.getElementById('drop-zone-content');
            const fileDisplay = document.getElementById('selected-file-display');
            const fileInput = document.getElementById('file-input');

            dropZoneContent.classList.remove('hidden');
            fileDisplay.classList.add('hidden');
            fileInput.value = '';

            // If we have an existing attachment, hide dropzone
            if (currentAttachment) {
                document.getElementById('file-drop-zone').classList.add('hidden');
            } else {
                document.getElementById('file-drop-zone').classList.remove('hidden');
            }
        }

        function showCurrentAttachment(attachment) {
            const container = document.getElementById('current-attachment');
            const link = document.getElementById('attachment-link');

            link.textContent = attachment.name;
            link.href = attachment.url;
            container.classList.remove('hidden');
            document.getElementById('file-drop-zone').classList.add('hidden');
        }

        // ==================== INITIALIZE APP ====================

        async function initApp() {
            setupEventListeners();

            // Initialize cooperative names datalist
            initCoopNamesList();

            // Load initial data
            await Promise.all([
                fetchAllRecords(),
                fetchDailyOps()
            ]);

            // Set default view to Dashboard
            switchView('dashboard');
        }

        // Start the app
        initApp();
    </script>
</body>

</html>